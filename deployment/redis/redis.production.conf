# ============================================================================
# Redis Production Configuration for Hafiportrait Photography Platform
# ============================================================================
# Version: 7.0+
# Purpose: Rate limiting, session storage, Socket.IO scaling, real-time caching
# ============================================================================

# NETWORK CONFIGURATION
# ============================================================================
# Bind hanya ke localhost untuk security (akses via local application only)
bind 127.0.0.1 ::1

# Port default Redis
port 6379

# Protected mode - HARUS enabled untuk production
protected-mode yes

# Max number of client connections
maxclients 10000

# TCP backlog
tcp-backlog 511

# Timeout idle connections (0 = disabled)
timeout 300

# TCP keepalive (seconds)
tcp-keepalive 300

# SECURITY CONFIGURATION
# ============================================================================
# CRITICAL: Set strong password - GANTI dengan password yang kuat!
# Generate dengan: openssl rand -base64 32
requirepass CHANGE_THIS_REDIS_PASSWORD_IN_PRODUCTION

# Disable dangerous commands
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG "CONFIG_a8f5h3k9m2n4"
rename-command SHUTDOWN "SHUTDOWN_b7g6j4l8p1q3"

# MEMORY MANAGEMENT
# ============================================================================
# Maximum memory (512MB untuk small-medium traffic)
# Adjust based on your VPS resources
maxmemory 512mb

# Eviction policy: Remove least recently used keys when memory limit reached
# Best for caching scenarios
maxmemory-policy allkeys-lru

# Samples for LRU algorithm (5 is good balance)
maxmemory-samples 5

# PERSISTENCE CONFIGURATION
# ============================================================================
# RDB Snapshots - untuk backup dan recovery
# Format: save <seconds> <changes>

# Save snapshot if at least 1 key changed in 900 seconds (15 minutes)
save 900 1

# Save snapshot if at least 10 keys changed in 300 seconds (5 minutes)
save 300 10

# Save snapshot if at least 10000 keys changed in 60 seconds (1 minute)
save 60 10000

# Stop writes if RDB snapshot fails (data safety)
stop-writes-on-bgsave-error yes

# Compress RDB files
rdbcompression yes

# Checksum untuk data integrity
rdbchecksum yes

# RDB filename
dbfilename dump.rdb

# Directory for RDB files (ensure this directory exists and is writable)
dir /var/lib/redis

# AOF (Append Only File) - Optional, untuk durability yang lebih tinggi
# Enable jika data persistence critical
appendonly no

# AOF filename
appendfilename "appendonly.aof"

# AOF sync frequency (always/everysec/no)
# appendfsync everysec

# LOGGING
# ============================================================================
# Log level: debug, verbose, notice, warning
loglevel notice

# Log file location (empty string = log to stdout)
logfile /var/log/redis/redis-server.log

# Number of databases
databases 16

# PERFORMANCE TUNING
# ============================================================================
# Disable transparent huge pages warning
always-show-logo no

# Lazy freeing (async deletion for better performance)
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# SLOW LOG CONFIGURATION
# ============================================================================
# Log queries slower than X microseconds (10000 = 10ms)
slowlog-log-slower-than 10000

# Keep last 128 slow queries
slowlog-max-len 128

# REPLICATION (Optional - for master-slave setup)
# ============================================================================
# Uncomment jika menggunakan replica
# replicaof <masterip> <masterport>
# masterauth <master-password>

# CLIENT OUTPUT BUFFER LIMITS
# ============================================================================
# Prevent memory issues from slow clients
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# ADVANCED CONFIGURATION
# ============================================================================
# Hash settings (memory optimization)
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List settings
list-max-ziplist-size -2
list-compress-depth 0

# Set settings
set-max-intset-entries 512

# Sorted set settings
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog sparse representation
hll-sparse-max-bytes 3000

# Streams settings
stream-node-max-bytes 4096
stream-node-max-entries 100

# Active rehashing
activerehashing yes

# Hz frequency (higher = more CPU, better latency)
hz 10

# Dynamic hz
dynamic-hz yes

# Jemalloc background thread
jemalloc-bg-thread yes

# ============================================================================
# HAFIPORTRAIT SPECIFIC NOTES
# ============================================================================
# Usage patterns:
# - Database 0: Rate limiting keys (TTL-based)
# - Database 1: Session storage (auth tokens)
# - Database 2: Socket.IO adapter (real-time connections)
# - Database 3: Photo upload progress tracking
# - Database 4: Cache (gallery queries, event data)
#
# Key prefixes:
# - rate-limit:*  -> Rate limiting
# - session:*     -> User sessions
# - socket:*      -> Socket.IO rooms and messages
# - upload:*      -> Photo upload progress
# - cache:*       -> Database query cache
# ============================================================================
